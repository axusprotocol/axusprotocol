<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AXUS | Token Collateral Check</title>
  <!-- –ò–∑–º–µ–Ω–∏–º —Å–ø–æ—Å–æ–± –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://unpkg.com/@tonconnect/ui@1.0.0/dist/tonconnect-ui.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 850px; margin: auto; padding: 2rem; line-height: 1.6; color: #111; background: #fff; }
    h1, h2 { color: #007aff; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; max-width: 400px; }
    .result { margin-top: 20px; padding: 1rem; border: 1px solid #ccc; background: #f9f9f9; }
    .back-button { margin-top: 2rem; display: inline-block; background: #e5e5e5; color: #333; padding: 10px 20px; text-decoration: none; border-radius: 5px; }
    /* –î–æ–±–∞–≤–∏–º —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
    #ton-connect { margin-bottom: 20px; min-height: 50px; }
  </style>
</head>
<body>
  <!-- –î–æ–±–∞–≤–∏–º —è–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ -->
  <div id="ton-connect" style="margin-bottom: 20px; display: block; min-height: 50px;"></div>
  
  <h1>AXUS Token Collateral Checker</h1>
  <p>Connect your TON wallet, pay 0.01 TON and check up to 3 tokens for eligibility.</p>
  <input type="text" id="token1" placeholder="Token address #1">
  <input type="text" id="token2" placeholder="Token address #2">
  <input type="text" id="token3" placeholder="Token address #3">
  <button onclick="initiatePayment()">Check Tokens (0.01 TON)</button>
  <div class="result" id="result"></div>
  <a class="back-button" href="index-en.html">‚Üê Back to main site</a>

  <script>
    // –û–±—ä—è–≤–∏–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
    let tonConnectUI;
    
    // –î–æ–∂–¥–µ–º—Å—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM loaded, initializing TonConnect...");
      
      // –ü—Ä–æ–≤–µ—Ä–∏–º, –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
      if (typeof TonConnectUI === 'undefined') {
        console.error("TonConnectUI is not defined. Library not loaded correctly.");
        document.getElementById("result").innerHTML = 
          "<strong style='color:red'>Error: TonConnect library not loaded. Please refresh the page.</strong>";
        return;
      }
      
      // –°–æ–∑–¥–∞–¥–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å CORS
      const manifestData = {
        "url": "https://axusprotocol.github.io/axusprotocol/",
        "name": "AXUS Protocol",
        "iconUrl": "https://axusprotocol.github.io/axusprotocol/axus-logo.png"
      };
      
      const manifestBlob = new Blob(
        [JSON.stringify(manifestData)], 
        {type: 'application/json'}
      );
      
      const manifestUrl = URL.createObjectURL(manifestBlob);
      
      try {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TonConnectUI —Å –ª–æ–∫–∞–ª—å–Ω—ã–º –º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–º
        tonConnectUI = new TonConnectUI({
          manifestUrl: manifestUrl,
          buttonRootId: "ton-connect"
        });
        
        console.log("TonConnectUI initialized successfully");
      } catch (error) {
        console.error("Error initializing TonConnectUI:", error);
        document.getElementById("result").innerHTML = 
          `<strong style='color:red'>Error initializing TonConnect: ${error.message}</strong>`;
      }
    });

    async function initiatePayment() {
      const inputs = [
        document.getElementById("token1").value.trim(),
        document.getElementById("token2").value.trim(),
        document.getElementById("token3").value.trim()
      ].filter(Boolean);
      
      const resultDiv = document.getElementById("result");
      
      if (inputs.length === 0) {
        resultDiv.innerHTML = "‚ùå Please enter at least one token address.";
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∏–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ tonConnectUI
      if (!tonConnectUI) {
        resultDiv.innerHTML = "‚ùå TonConnect not initialized. Please refresh the page.";
        return;
      }
      
      try {
        const connected = await tonConnectUI.connected;
        if (!connected) {
          resultDiv.innerHTML = "‚ùå Please connect your wallet first.";
          return;
        }
        
        resultDiv.innerHTML = "‚è≥ Awaiting payment confirmation...";
        
        await tonConnectUI.sendTransaction({
          validUntil: Math.floor(Date.now() / 1000) + 600,
          messages: [
            {
              address: "UQBpdVR9LVBixqJ2JRj-c8-NtNa3REQL7B2jnEyrQ5JiS5IA",
              amount: "10000000", // 0.01 TON
              payload: null
            }
          ]
        });
        
        resultDiv.innerHTML = "<strong>‚úÖ Payment received. Checking tokens...</strong><br/><br/>";
        
        for (let address of inputs) {
          resultDiv.innerHTML += `<em>üîé ${address}</em><br/>`;
          await checkToken(address);
        }
      } catch (err) {
        console.error("Payment error:", err);
        resultDiv.innerHTML = "‚ùå Payment failed or cancelled.";
      }
    }

    async function checkToken(address) {
      const resultDiv = document.getElementById("result");
      try {
        const res = await fetch(`https://tonapi.io/v2/tokens/${address}`);
        if (!res.ok) {
          resultDiv.innerHTML += `‚ùå Token not found in TON API: ${address}<br/><br/>`;
          return;
        }
        
        const data = await res.json();
        let passed = 0;
        const checks = [];
        
        const createdAt = data.metadata?.created_at;
        const ageOk = createdAt && (Date.now() - new Date(createdAt).getTime() > 90 * 24 * 60 * 60 * 1000);
        if (ageOk) { passed++; checks.push("‚úÖ Age ‚â• 3 months"); } else { checks.push("‚ùå Age < 3 months or unknown"); }
        
        const holders = data.analytics?.holders || 0;
        if (holders >= 50) { passed++; checks.push(`‚úÖ ${holders} holders`); } else { checks.push(`‚ùå Only ${holders} holders`); }
        
        const price = data.price?.price || 0;
        if (price > 0.000001) { passed++; checks.push(`‚úÖ Price: ${price.toFixed(6)} TON`); } else { checks.push(`‚ùå Price too low: ${price.toFixed(6)} TON`); }
        
        const liquidity = data.analytics?.liquidity_usd || 0;
        if (liquidity >= 500) { passed++; checks.push(`‚úÖ Liquidity: $${liquidity}`); } else { checks.push(`‚ùå Liquidity too low: $${liquidity}`); }
        
        const status = passed >= 3 ? "‚úÖ Token is eligible for collateral." : "‚ùå Token does not meet eligibility criteria.";
        
        resultDiv.innerHTML += `
          <strong>${data.name || 'Unknown'}:</strong><br/>
          ${checks.join('<br/>')}<br/><strong>${status}</strong><br/><br/>
        `;
      } catch (err) {
        console.error("Token check error:", err);
        resultDiv.innerHTML += `‚ùå Failed to fetch token data: ${address}<br/><br/>`;
      }
    }
  </script>
</body>
</html>
