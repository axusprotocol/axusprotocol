<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AXUS | Token Collateral Check</title>
  
  <!-- –ü–æ–ø—Ä–æ–±—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–æ—Å–æ–±–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <!-- 1. –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ unpkg —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π -->
  <script src="https://unpkg.com/@tonconnect/ui@1.0.0/dist/tonconnect-ui.js"></script>
  
  <!-- 2. –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ jsdelivr –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tonconnect/ui@1.0.0/dist/tonconnect-ui.js"></script>
  
  <!-- 3. –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑–æ–≤–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ SDK -->
  <script src="https://unpkg.com/@tonconnect/sdk@2.0.0/dist/tonconnect-sdk.min.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; max-width: 850px; margin: auto; padding: 2rem; line-height: 1.6; color: #111; background: #fff; }
    h1, h2 { color: #007aff; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; max-width: 400px; }
    .result { margin-top: 20px; padding: 1rem; border: 1px solid #ccc; background: #f9f9f9; }
    .back-button { margin-top: 2rem; display: inline-block; background: #e5e5e5; color: #333; padding: 10px 20px; text-decoration: none; border-radius: 5px; }
    #ton-connect { margin-bottom: 20px; min-height: 50px; }
    .custom-connect-button { 
      display: inline-block; 
      background: #0088CC; 
      color: white; 
      padding: 10px 20px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: bold;
      border: none;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>AXUS Token Collateral Checker</h1>
  
  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∫–Ω–æ–ø–∫–∏ TonConnect -->
  <div id="ton-connect" style="margin-bottom: 20px; display: block; min-height: 50px;"></div>
  
  <!-- –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞, –µ—Å–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è -->
  <button id="custom-connect-button" class="custom-connect-button" style="display: none;">
    Connect TON Wallet
  </button>
  
  <div id="connection-status"></div>
  
  <p>Connect your TON wallet, pay 0.01 TON and check up to 3 tokens for eligibility.</p>
  <input type="text" id="token1" placeholder="Token address #1">
  <input type="text" id="token2" placeholder="Token address #2">
  <input type="text" id="token3" placeholder="Token address #3">
  <button id="check-button" onclick="initiatePayment()">Check Tokens (0.01 TON)</button>
  <div class="result" id="result"></div>
  <a class="back-button" href="index-en.html">‚Üê Back to main site</a>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let tonConnectUI = null;
    let tonConnectSDK = null;
    let isWalletConnected = false;
    let connectedWalletAddress = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    function showMessage(message, isError = false) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = isError 
        ? `<strong style="color:red">${message}</strong>` 
        : message;
      console.log(isError ? `[ERROR] ${message}` : message);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    function updateConnectionStatus(status) {
      document.getElementById("connection-status").innerHTML = status;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TonConnectUI
    function initTonConnectUI() {
      try {
        console.log("Trying to initialize TonConnectUI...");
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ TonConnectUI
        if (typeof TonConnectUI === 'undefined') {
          console.error("TonConnectUI is not defined");
          throw new Error("TonConnectUI library not loaded");
        }
        
        // –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç
        const manifestData = {
          "url": "https://axusprotocol.github.io/axusprotocol/",
          "name": "AXUS Protocol",
          "iconUrl": "https://axusprotocol.github.io/axusprotocol/axus-logo.png"
        };
        
        const manifestBlob = new Blob(
          [JSON.stringify(manifestData)], 
          {type: 'application/json'}
        );
        
        const manifestUrl = URL.createObjectURL(manifestBlob);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TonConnectUI
        tonConnectUI = new TonConnectUI({
          manifestUrl: manifestUrl,
          buttonRootId: "ton-connect"
        });
        
        console.log("TonConnectUI initialized successfully");
        
        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        tonConnectUI.onStatusChange((wallet) => {
          if (wallet) {
            isWalletConnected = true;
            connectedWalletAddress = wallet.account.address;
            updateConnectionStatus(`<p style="color:green">Connected: ${wallet.account.address}</p>`);
          } else {
            isWalletConnected = false;
            connectedWalletAddress = null;
            updateConnectionStatus("");
          }
        });
        
        return true;
      } catch (error) {
        console.error("Error initializing TonConnectUI:", error);
        return false;
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TonConnect SDK (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
    function initTonConnectSDK() {
      try {
        console.log("Trying to initialize TonConnect SDK...");
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ TonConnect
        if (typeof TonConnect === 'undefined') {
          console.error("TonConnect SDK is not defined");
          throw new Error("TonConnect SDK library not loaded");
        }
        
        // –°–æ–∑–¥–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç
        const manifestData = {
          "url": "https://axusprotocol.github.io/axusprotocol/",
          "name": "AXUS Protocol",
          "iconUrl": "https://axusprotocol.github.io/axusprotocol/axus-logo.png"
        };
        
        const manifestBlob = new Blob(
          [JSON.stringify(manifestData)], 
          {type: 'application/json'}
        );
        
        const manifestUrl = URL.createObjectURL(manifestBlob);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TonConnect SDK
        tonConnectSDK = new TonConnect.TonConnect({
          manifestUrl: manifestUrl
        });
        
        console.log("TonConnect SDK initialized successfully");
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.getElementById("custom-connect-button").style.display = "block";
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        document.getElementById("custom-connect-button").addEventListener("click", async () => {
          try {
            const wallets = await tonConnectSDK.getWallets();
            
            if (wallets.length === 0) {
              showMessage("No TON wallets found. Please install a TON wallet.", true);
              return;
            }
            
            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫–æ—à–µ–ª–µ–∫
            const wallet = wallets[0];
            
            // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –∫–æ—à–µ–ª—å–∫—É
            tonConnectSDK.connect({
              jsBridgeKey: wallet.jsBridgeKey,
              universalLink: wallet.universalLink,
              bridgeUrl: wallet.bridgeUrl
            });
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            tonConnectSDK.onStatusChange((wallet) => {
              if (wallet) {
                isWalletConnected = true;
                connectedWalletAddress = wallet.account.address;
                updateConnectionStatus(`<p style="color:green">Connected: ${wallet.account.address}</p>`);
              } else {
                isWalletConnected = false;
                connectedWalletAddress = null;
                updateConnectionStatus("");
              }
            });
          } catch (error) {
            console.error("Error connecting wallet:", error);
            showMessage("Error connecting wallet: " + error.message, true);
          }
        });
        
        return true;
      } catch (error) {
        console.error("Error initializing TonConnect SDK:", error);
        return false;
      }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM loaded, initializing...");
      
      // –ü—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å TonConnectUI
      const uiInitialized = initTonConnectUI();
      
      // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, –ø—Ä–æ–±—É–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å TonConnect SDK
      if (!uiInitialized) {
        console.log("TonConnectUI initialization failed, trying TonConnect SDK...");
        const sdkInitialized = initTonConnectSDK();
        
        if (!sdkInitialized) {
          showMessage("Failed to initialize TON wallet connection. Please make sure you have a compatible browser and no extensions blocking scripts.", true);
        }
      }
    });

    async function initiatePayment() {
      const inputs = [
        document.getElementById("token1").value.trim(),
        document.getElementById("token2").value.trim(),
        document.getElementById("token3").value.trim()
      ].filter(Boolean);
      
      const resultDiv = document.getElementById("result");
      
      if (inputs.length === 0) {
        resultDiv.innerHTML = "‚ùå Please enter at least one token address.";
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞
      if (!isWalletConnected) {
        resultDiv.innerHTML = "‚ùå Please connect your wallet first.";
        return;
      }
      
      resultDiv.innerHTML = "‚è≥ Awaiting payment confirmation...";
      
      try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —á–µ—Ä–µ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        if (tonConnectUI) {
          await tonConnectUI.sendTransaction({
            validUntil: Math.floor(Date.now() / 1000) + 600,
            messages: [
              {
                address: "UQBpdVR9LVBixqJ2JRj-c8-NtNa3REQL7B2jnEyrQ5JiS5IA",
                amount: "10000000", // 0.01 TON
                payload: null
              }
            ]
          });
        } else if (tonConnectSDK) {
          await tonConnectSDK.sendTransaction({
            validUntil: Math.floor(Date.now() / 1000) + 600,
            messages: [
              {
                address: "UQBpdVR9LVBixqJ2JRj-c8-NtNa3REQL7B2jnEyrQ5JiS5IA",
                amount: "10000000", // 0.01 TON
                payload: null
              }
            ]
          });
        } else {
          throw new Error("No wallet connection interface available");
        }
        
        resultDiv.innerHTML = "<strong>‚úÖ Payment received. Checking tokens...</strong><br/><br/>";
        
        for (let address of inputs) {
          resultDiv.innerHTML += `<em>üîé ${address}</em><br/>`;
          await checkToken(address);
        }
      } catch (err) {
        console.error("Payment error:", err);
        resultDiv.innerHTML = "‚ùå Payment failed or cancelled.";
      }
    }

    async function checkToken(address) {
      const resultDiv = document.getElementById("result");
      try {
        const res = await fetch(`https://tonapi.io/v2/tokens/${address}`);
        if (!res.ok) {
          resultDiv.innerHTML += `‚ùå Token not found in TON API: ${address}<br/><br/>`;
          return;
        }
        
        const data = await res.json();
        let passed = 0;
        const checks = [];
        
        const createdAt = data.metadata?.created_at;
        const ageOk = createdAt && (Date.now() - new Date(createdAt).getTime() > 90 * 24 * 60 * 60 * 1000);
        if (ageOk) { passed++; checks.push("‚úÖ Age ‚â• 3 months"); } else { checks.push("‚ùå Age < 3 months or unknown"); }
        
        const holders = data.analytics?.holders || 0;
        if (holders >= 50) { passed++; checks.push(`‚úÖ ${holders} holders`); } else { checks.push(`‚ùå Only ${holders} holders`); }
        
        const price = data.price?.price || 0;
        if (price > 0.000001) { passed++; checks.push(`‚úÖ Price: ${price.toFixed(6)} TON`); } else { checks.push(`‚ùå Price too low: ${price.toFixed(6)} TON`); }
        
        const liquidity = data.analytics?.liquidity_usd || 0;
        if (liquidity >= 500) { passed++; checks.push(`‚úÖ Liquidity: $${liquidity}`); } else { checks.push(`‚ùå Liquidity too low: $${liquidity}`); }
        
        const status = passed >= 3 ? "‚úÖ Token is eligible for collateral." : "‚ùå Token does not meet eligibility criteria.";
        
        resultDiv.innerHTML += `
          <strong>${data.name || 'Unknown'}:</strong><br/>
          ${checks.join('<br/>')}<br/><strong>${status}</strong><br/><br/>
        `;
      } catch (err) {
        console.error("Token check error:", err);
        resultDiv.innerHTML += `‚ùå Failed to fetch token data: ${address}<br/><br/>`;
      }
    }
  </script>
</body>
</html>
