<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AXUS | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤</title>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 850px; margin: 0 auto; padding: 2rem; line-height: 1.6; color: #111; background: #fff; }
    h1, h2 { color: #007aff; }
    input, button { padding: 12px; margin: 8px 0; width: 100%; max-width: 400px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
    button { background: #007aff; color: white; font-weight: bold; cursor: pointer; transition: background 0.2s; }
    button:hover { background: #0062cc; }
    button:disabled { background: #cccccc; cursor: not-allowed; }
    .result { margin-top: 20px; padding: 1.5rem; border: 1px solid #ddd; background: #f9f9f9; border-radius: 8px; }
    .back-button { margin-top: 2rem; display: inline-block; background: #e5e5e5; color: #333; padding: 12px 24px; text-decoration: none; border-radius: 6px; }
    #ton-connect { 
      margin: 20px 0;
      min-height: 60px;
      display: flex;
      justify-content: center;
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007aff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .error-message {
      color: #d32f2f;
      padding: 16px;
      border: 1px solid #ffcdd2;
      background: #ffebee;
      border-radius: 8px;
      text-align: center;
      max-width: 500px;
      margin: 0 auto;
    }
    .retry-button {
      background: #007aff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 15px;
      font-weight: bold;
    }
    .wallet-connected {
      color: #388e3c;
      font-weight: bold;
      text-align: center;
      padding: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

  <div id="ton-connect">
    <div class="loader"></div>
  </div>

  <h1>AXUS –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤</h1>
  <p>–ü–æ–¥–∫–ª—é—á–∏—Ç–µ TON –∫–æ—à–µ–ª–µ–∫, –æ–ø–ª–∞—Ç–∏—Ç–µ 0.01 TON –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ 3 —Ç–æ–∫–µ–Ω–æ–≤</p>

  <input type="text" id="token1" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ #1 (–Ω–∞–ø—Ä–∏–º–µ—Ä: EQABC...)">
  <input type="text" id="token2" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ #2 (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
  <input type="text" id="token3" placeholder="–ê–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞ #3 (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
  <button id="check-button" onclick="initiatePayment()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–æ–∫–µ–Ω—ã (0.01 TON)</button>

  <div class="result" id="result"></div>

  <a class="back-button" href="index-en.html">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

  <script>
    let tonConnectUI;
    let isWalletConnected = false;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    async function initializeTonConnect() {
      const tonConnectElement = document.getElementById('ton-connect');
      const checkButton = document.getElementById('check-button');
      
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ TonConnect
        if (typeof TonConnectUI === 'undefined') {
          throw new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ TonConnect –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å');
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        tonConnectElement.innerHTML = '<div class="loader"></div>';
        checkButton.disabled = true;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º TonConnect
        tonConnectUI = new TonConnectUI.TonConnectUI({
          manifestUrl: "https://axusprotocol.github.io/axusprotocol/tonconnect-manifest.json",
          buttonRootId: "ton-connect",
          language: 'ru',
          uiPreferences: {
            theme: 'SYSTEM',
            borderRadius: 'm',
            colorsSet: {
              [TonConnectUI.THEME.LIGHT]: {
                connectButton: {
                  background: '#007aff',
                  foreground: 'white'
                }
              },
              [TonConnectUI.THEME.DARK]: {
                connectButton: {
                  background: '#007aff',
                  foreground: 'white'
                }
              }
            }
          }
        });

        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        tonConnectUI.connectionStatusChange((status) => {
          isWalletConnected = status === TonConnectUI.CONNECTION_STATUS.CONNECTED;
          console.log('–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', status);
          
          if (isWalletConnected) {
            checkButton.disabled = false;
            // tonConnectElement.innerHTML = '<div class="wallet-connected">‚úì –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω</div>';
          } else {
            checkButton.disabled = true;
          }
        });

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        const connected = await tonConnectUI.connected;
        if (connected) {
          isWalletConnected = true;
          checkButton.disabled = false;
        }

      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ TonConnect:", error);
        
        retryCount++;
        if (retryCount <= MAX_RETRIES) {
          tonConnectElement.innerHTML = 
            '<div class="error-message">' +
              '<strong>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</strong><br><br>' +
              '–ü–æ–ø—ã—Ç–∫–∞ ' + retryCount + ' –∏–∑ ' + MAX_RETRIES + '...' +
              '<div class="loader" style="margin: 15px auto;"></div>' +
            '</div>';
          
          // –ü—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(initializeTonConnect, 3000);
        } else {
          tonConnectElement.innerHTML = 
            '<div class="error-message">' +
              '<strong>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</strong><br><br>' +
              '–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:<br>' +
              '1. –ü—Ä–æ–±–ª–µ–º—ã —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º<br>' +
              '2. –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏<br>' +
              '3. –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏<br><br>' +
              '<button class="retry-button" onclick="location.reload()">‚ü≥ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>' +
            '</div>';
        }
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener("DOMContentLoaded", initializeTonConnect);

    async function initiatePayment() {
      const inputs = [
        document.getElementById("token1").value.trim(),
        document.getElementById("token2").value.trim(),
        document.getElementById("token3").value.trim()
      ].filter(addr => addr && addr.length > 10); // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ –∞–¥—Ä–µ—Å–∞

      const resultDiv = document.getElementById("result");
      const checkButton = document.getElementById('check-button');

      if (inputs.length === 0) {
        resultDiv.innerHTML = '<div style="color: #d32f2f;">‚ùå –í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å —Ç–æ–∫–µ–Ω–∞</div>';
        return;
      }

      if (!isWalletConnected) {
        resultDiv.innerHTML = '<div style="color: #d32f2f;">‚ùå –°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫</div>';
        return;
      }

      resultDiv.innerHTML = '<div style="color: #007aff;">‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞...</div>';
      checkButton.disabled = true;

      try {
        const transaction = {
          validUntil: Math.floor(Date.now() / 1000) + 300, // 5 –º–∏–Ω—É—Ç
          messages: [
            {
              address: "UQBpdVR9LVBixqJ2JRj-c8-NtNa3REQL7B2jnEyrQ5JiS5IA",
              amount: "10000000", // 0.01 TON
              payload: null
            }
          ]
        };

        await tonConnectUI.sendTransaction(transaction);

        resultDiv.innerHTML = '<div style="color: #388e3c;">‚úÖ –ü–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω—ã...</div><br>';
        for (let address of inputs) {
          resultDiv.innerHTML += `<div><em>üîé –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω: ${address}</em></div>`;
          await checkToken(address);
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞:", err);
        let errorMessage = "‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞";
        if (err.message.includes("rejected")) {
          errorMessage = "‚ùå –í—ã –æ—Ç–º–µ–Ω–∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é";
        } else if (err.message.includes("timeout")) {
          errorMessage = "‚ùå –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ";
        }
        resultDiv.innerHTML = `<div style="color: #d32f2f;">${errorMessage}</div>`;
      } finally {
        checkButton.disabled = false;
      }
    }

    async function checkToken(address) {
      const resultDiv = document.getElementById("result");

      try {
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–∏–º–∏—Ç–æ–≤ API
        await new Promise(resolve => setTimeout(resolve, 500));
        
        const res = await fetch(`https://tonapi.io/v2/tokens/${address}`);
        
        if (!res.ok) {
          throw new Error(res.status === 404 ? "–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω" : "–û—à–∏–±–∫–∞ API");
        }

        const data = await res.json();
        renderTokenResults(address, data);
        
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:", err);
        resultDiv.innerHTML += `
          <div style="margin-top: 10px; color: #d32f2f;">
            ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞ ${address}<br>
            <small>${err.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞"}</small>
          </div><br>
        `;
      }
    }

    function renderTokenResults(address, tokenData) {
      const resultDiv = document.getElementById("result");
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–∫–µ–Ω–∞
      const checks = [];
      let passedChecks = 0;

      // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ —Ç–æ–∫–µ–Ω–∞ (‚â•3 –º–µ—Å—è—Ü–µ–≤)
      const createdAt = tokenData.metadata?.created_at;
      const threeMonthsAgo = Date.now() - 90 * 24 * 60 * 60 * 1000;
      const isOldEnough = createdAt && new Date(createdAt).getTime() < threeMonthsAgo;
      checks.push({
        name: "–í–æ–∑—Ä–∞—Å—Ç ‚â•3 –º–µ—Å—è—Ü–µ–≤",
        passed: isOldEnough,
        value: createdAt ? new Date(createdAt).toLocaleDateString() : "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
      });
      if (isOldEnough) passedChecks++;

      // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–µ—Ä–∂–∞—Ç–µ–ª–µ–π (‚â•50)
      const holders = tokenData.analytics?.holders || 0;
      const hasEnoughHolders = holders >= 50;
      checks.push({
        name: "–î–µ—Ä–∂–∞—Ç–µ–ª–µ–π ‚â•50",
        passed: hasEnoughHolders,
        value: holders
      });
      if (hasEnoughHolders) passedChecks++;

      // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω—ã (>0.000001 TON)
      const price = tokenData.price?.price || 0;
      const hasGoodPrice = price > 0.000001;
      checks.push({
        name: "–¶–µ–Ω–∞ > 0.000001 TON",
        passed: hasGoodPrice,
        value: price.toFixed(8) + " TON"
      });
      if (hasGoodPrice) passedChecks++;

      // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ (‚â•$500)
      const liquidity = tokenData.analytics?.liquidity_usd || 0;
      const hasEnoughLiquidity = liquidity >= 500;
      checks.push({
        name: "–õ–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å ‚â•$500",
        passed: hasEnoughLiquidity,
        value: "$" + liquidity.toFixed(2)
      });
      if (hasEnoughLiquidity) passedChecks++;

      // –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      const tokenName = tokenData.name || address.slice(0, 6) + "..." + address.slice(-4);
      const isEligible = passedChecks >= 3; // –¢—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 3 –∏–∑ 4 –ø—Ä–æ–≤–µ—Ä–æ–∫

      let html = `
        <div style="margin: 15px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: white;">
          <strong style="font-size: 1.1em;">${tokenName}</strong>
          <div style="margin-top: 10px;">
      `;

      checks.forEach(check => {
        html += `
          <div style="margin: 5px 0; display: flex; align-items: center;">
            <span style="color: ${check.passed ? '#388e3c' : '#d32f2f'}; margin-right: 8px;">
              ${check.passed ? '‚úì' : '‚úó'}
            </span>
            <span>${check.name}: <strong>${check.value}</strong></span>
          </div>
        `;
      });

      html += `
          </div>
          <div style="margin-top: 10px; font-weight: bold; color: ${isEligible ? '#388e3c' : '#d32f2f'};">
            ${isEligible ? '‚úÖ –¢–æ–∫–µ–Ω –ø–æ–¥—Ö–æ–¥–∏—Ç –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∑–∞–ª–æ–≥–∞' : '‚ùå –¢–æ–∫–µ–Ω –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º'}
          </div>
        </div>
      `;

      resultDiv.innerHTML += html;
    }
  </script>
</body>
</html>
