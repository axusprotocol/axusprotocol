<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AXUS | Token Collateral Check</title>
  
  <!-- Попробуем несколько способов загрузки библиотеки -->
  <!-- 1. Загрузка через unpkg с конкретной версией -->
  <script src="https://unpkg.com/@tonconnect/ui@1.0.0/dist/tonconnect-ui.js"></script>
  
  <!-- 2. Загрузка через jsdelivr как альтернативный CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@tonconnect/ui@1.0.0/dist/tonconnect-ui.js"></script>
  
  <!-- 3. Загрузка базовой библиотеки SDK -->
  <script src="https://unpkg.com/@tonconnect/sdk@2.0.0/dist/tonconnect-sdk.min.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; max-width: 850px; margin: auto; padding: 2rem; line-height: 1.6; color: #111; background: #fff; }
    h1, h2 { color: #007aff; }
    input, button { padding: 10px; margin: 5px 0; width: 100%; max-width: 400px; }
    .result { margin-top: 20px; padding: 1rem; border: 1px solid #ccc; background: #f9f9f9; }
    .back-button { margin-top: 2rem; display: inline-block; background: #e5e5e5; color: #333; padding: 10px 20px; text-decoration: none; border-radius: 5px; }
    #ton-connect { margin-bottom: 20px; min-height: 50px; }
    .custom-connect-button { 
      display: inline-block; 
      background: #0088CC; 
      color: white; 
      padding: 10px 20px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: bold;
      border: none;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>AXUS Token Collateral Checker</h1>
  
  <!-- Контейнер для стандартной кнопки TonConnect -->
  <div id="ton-connect" style="margin-bottom: 20px; display: block; min-height: 50px;"></div>
  
  <!-- Резервная кнопка, если стандартная не загрузится -->
  <button id="custom-connect-button" class="custom-connect-button" style="display: none;">
    Connect TON Wallet
  </button>
  
  <div id="connection-status"></div>
  
  <p>Connect your TON wallet, pay 0.01 TON and check up to 3 tokens for eligibility.</p>
  <input type="text" id="token1" placeholder="Token address #1">
  <input type="text" id="token2" placeholder="Token address #2">
  <input type="text" id="token3" placeholder="Token address #3">
  <button id="check-button" onclick="initiatePayment()">Check Tokens (0.01 TON)</button>
  <div class="result" id="result"></div>
  <a class="back-button" href="index-en.html">← Back to main site</a>

  <script>
    // Глобальные переменные
    let tonConnectUI = null;
    let tonConnectSDK = null;
    let isWalletConnected = false;
    let connectedWalletAddress = null;
    
    // Функция для отображения сообщений
    function showMessage(message, isError = false) {
      const resultDiv = document.getElementById("result");
      resultDiv.innerHTML = isError 
        ? `<strong style="color:red">${message}</strong>` 
        : message;
      console.log(isError ? `[ERROR] ${message}` : message);
    }
    
    // Функция для обновления статуса подключения
    function updateConnectionStatus(status) {
      document.getElementById("connection-status").innerHTML = status;
    }
    
    // Функция для инициализации TonConnectUI
    function initTonConnectUI() {
      try {
        console.log("Trying to initialize TonConnectUI...");
        
        // Проверяем, доступен ли TonConnectUI
        if (typeof TonConnectUI === 'undefined') {
          console.error("TonConnectUI is not defined");
          throw new Error("TonConnectUI library not loaded");
        }
        
        // Создаем локальный манифест
        const manifestData = {
          "url": "https://axusprotocol.github.io/axusprotocol/",
          "name": "AXUS Protocol",
          "iconUrl": "https://axusprotocol.github.io/axusprotocol/axus-logo.png"
        };
        
        const manifestBlob = new Blob(
          [JSON.stringify(manifestData)], 
          {type: 'application/json'}
        );
        
        const manifestUrl = URL.createObjectURL(manifestBlob);
        
        // Инициализируем TonConnectUI
        tonConnectUI = new TonConnectUI({
          manifestUrl: manifestUrl,
          buttonRootId: "ton-connect"
        });
        
        console.log("TonConnectUI initialized successfully");
        
        // Слушаем изменения статуса подключения
        tonConnectUI.onStatusChange((wallet) => {
          if (wallet) {
            isWalletConnected = true;
            connectedWalletAddress = wallet.account.address;
            updateConnectionStatus(`<p style="color:green">Connected: ${wallet.account.address}</p>`);
          } else {
            isWalletConnected = false;
            connectedWalletAddress = null;
            updateConnectionStatus("");
          }
        });
        
        return true;
      } catch (error) {
        console.error("Error initializing TonConnectUI:", error);
        return false;
      }
    }
    
    // Функция для инициализации TonConnect SDK (резервный вариант)
    function initTonConnectSDK() {
      try {
        console.log("Trying to initialize TonConnect SDK...");
        
        // Проверяем, доступен ли TonConnect
        if (typeof TonConnect === 'undefined') {
          console.error("TonConnect SDK is not defined");
          throw new Error("TonConnect SDK library not loaded");
        }
        
        // Создаем локальный манифест
        const manifestData = {
          "url": "https://axusprotocol.github.io/axusprotocol/",
          "name": "AXUS Protocol",
          "iconUrl": "https://axusprotocol.github.io/axusprotocol/axus-logo.png"
        };
        
        const manifestBlob = new Blob(
          [JSON.stringify(manifestData)], 
          {type: 'application/json'}
        );
        
        const manifestUrl = URL.createObjectURL(manifestBlob);
        
        // Инициализируем TonConnect SDK
        tonConnectSDK = new TonConnect.TonConnect({
          manifestUrl: manifestUrl
        });
        
        console.log("TonConnect SDK initialized successfully");
        
        // Показываем кастомную кнопку
        document.getElementById("custom-connect-button").style.display = "block";
        
        // Добавляем обработчик для кастомной кнопки
        document.getElementById("custom-connect-button").addEventListener("click", async () => {
          try {
            const wallets = await tonConnectSDK.getWallets();
            
            if (wallets.length === 0) {
              showMessage("No TON wallets found. Please install a TON wallet.", true);
              return;
            }
            
            // Выбираем первый доступный кошелек
            const wallet = wallets[0];
            
            // Подключаемся к кошельку
            tonConnectSDK.connect({
              jsBridgeKey: wallet.jsBridgeKey,
              universalLink: wallet.universalLink,
              bridgeUrl: wallet.bridgeUrl
            });
            
            // Слушаем изменения статуса подключения
            tonConnectSDK.onStatusChange((wallet) => {
              if (wallet) {
                isWalletConnected = true;
                connectedWalletAddress = wallet.account.address;
                updateConnectionStatus(`<p style="color:green">Connected: ${wallet.account.address}</p>`);
              } else {
                isWalletConnected = false;
                connectedWalletAddress = null;
                updateConnectionStatus("");
              }
            });
          } catch (error) {
            console.error("Error connecting wallet:", error);
            showMessage("Error connecting wallet: " + error.message, true);
          }
        });
        
        return true;
      } catch (error) {
        console.error("Error initializing TonConnect SDK:", error);
        return false;
      }
    }
    
    // Инициализация при загрузке страницы
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM loaded, initializing...");
      
      // Пробуем инициализировать TonConnectUI
      const uiInitialized = initTonConnectUI();
      
      // Если не удалось, пробуем инициализировать TonConnect SDK
      if (!uiInitialized) {
        console.log("TonConnectUI initialization failed, trying TonConnect SDK...");
        const sdkInitialized = initTonConnectSDK();
        
        if (!sdkInitialized) {
          showMessage("Failed to initialize TON wallet connection. Please make sure you have a compatible browser and no extensions blocking scripts.", true);
        }
      }
    });

    async function initiatePayment() {
      const inputs = [
        document.getElementById("token1").value.trim(),
        document.getElementById("token2").value.trim(),
        document.getElementById("token3").value.trim()
      ].filter(Boolean);
      
      const resultDiv = document.getElementById("result");
      
      if (inputs.length === 0) {
        resultDiv.innerHTML = "❌ Please enter at least one token address.";
        return;
      }
      
      // Проверяем подключение кошелька
      if (!isWalletConnected) {
        resultDiv.innerHTML = "❌ Please connect your wallet first.";
        return;
      }
      
      resultDiv.innerHTML = "⏳ Awaiting payment confirmation...";
      
      try {
        // Отправляем транзакцию через доступный интерфейс
        if (tonConnectUI) {
          await tonConnectUI.sendTransaction({
            validUntil: Math.floor(Date.now() / 1000) + 600,
            messages: [
              {
                address: "UQBpdVR9LVBixqJ2JRj-c8-NtNa3REQL7B2jnEyrQ5JiS5IA",
                amount: "10000000", // 0.01 TON
                payload: null
              }
            ]
          });
        } else if (tonConnectSDK) {
          await tonConnectSDK.sendTransaction({
            validUntil: Math.floor(Date.now() / 1000) + 600,
            messages: [
              {
                address: "UQBpdVR9LVBixqJ2JRj-c8-NtNa3REQL7B2jnEyrQ5JiS5IA",
                amount: "10000000", // 0.01 TON
                payload: null
              }
            ]
          });
        } else {
          throw new Error("No wallet connection interface available");
        }
        
        resultDiv.innerHTML = "<strong>✅ Payment received. Checking tokens...</strong><br/><br/>";
        
        for (let address of inputs) {
          resultDiv.innerHTML += `<em>🔎 ${address}</em><br/>`;
          await checkToken(address);
        }
      } catch (err) {
        console.error("Payment error:", err);
        resultDiv.innerHTML = "❌ Payment failed or cancelled.";
      }
    }

    async function checkToken(address) {
      const resultDiv = document.getElementById("result");
      try {
        const res = await fetch(`https://tonapi.io/v2/tokens/${address}`);
        if (!res.ok) {
          resultDiv.innerHTML += `❌ Token not found in TON API: ${address}<br/><br/>`;
          return;
        }
        
        const data = await res.json();
        let passed = 0;
        const checks = [];
        
        const createdAt = data.metadata?.created_at;
        const ageOk = createdAt && (Date.now() - new Date(createdAt).getTime() > 90 * 24 * 60 * 60 * 1000);
        if (ageOk) { passed++; checks.push("✅ Age ≥ 3 months"); } else { checks.push("❌ Age < 3 months or unknown"); }
        
        const holders = data.analytics?.holders || 0;
        if (holders >= 50) { passed++; checks.push(`✅ ${holders} holders`); } else { checks.push(`❌ Only ${holders} holders`); }
        
        const price = data.price?.price || 0;
        if (price > 0.000001) { passed++; checks.push(`✅ Price: ${price.toFixed(6)} TON`); } else { checks.push(`❌ Price too low: ${price.toFixed(6)} TON`); }
        
        const liquidity = data.analytics?.liquidity_usd || 0;
        if (liquidity >= 500) { passed++; checks.push(`✅ Liquidity: $${liquidity}`); } else { checks.push(`❌ Liquidity too low: $${liquidity}`); }
        
        const status = passed >= 3 ? "✅ Token is eligible for collateral." : "❌ Token does not meet eligibility criteria.";
        
        resultDiv.innerHTML += `
          <strong>${data.name || 'Unknown'}:</strong><br/>
          ${checks.join('<br/>')}<br/><strong>${status}</strong><br/><br/>
        `;
      } catch (err) {
        console.error("Token check error:", err);
        resultDiv.innerHTML += `❌ Failed to fetch token data: ${address}<br/><br/>`;
      }
    }
  </script>
</body>
</html>
